/*!
 * Torro Forms Version 1.0.0-beta.8 (http://torro-forms.com)
 * Licensed under GNU General Public License v3 (http://www.gnu.org/licenses/gpl-3.0.html)
 */
window.torro=window.torro||{},function(e,t,n,i){"use strict";function s(e){a++,r["builder"+a]=[],this.instanceNumber=a,this.$el=t(e)}var o,a=0,l=[],r={};n.extend(s.prototype,{elementTypes:void 0,form:void 0,formView:void 0,init:function(){return this.$el.length?void e.api.init().done(n.bind(function(){(new e.api.collections.ElementTypes).fetch({data:{context:"edit"},context:this,success:function(s){this.elementTypes=e.Builder.ElementTypes.fromApiCollection(s),"auto-draft"!==t("#original_post_status").val()?new e.api.models.Form({id:parseInt(t("#post_ID").val(),10)}).fetch({data:{context:"edit",_embed:!0},context:this,success:function(e){t(document).ready(n.bind(function(){var t;l.push(this.instanceCount),this.setupInitialData(e.attributes),this.setupViews();for(t in r["builder"+this.instanceCount])r["builder"+this.instanceCount][t](this);delete r["builder"+this.instanceCount]},this))},error:function(){t(document).ready(n.bind(function(){this.fail(i.couldNotLoadData)},this))}}):t(document).ready(n.bind(function(){var e;l.push(this.instanceCount),this.setupInitialData(),this.setupViews();for(e in r["builder"+this.instanceCount])r["builder"+this.instanceCount][e](this);delete r["builder"+this.instanceCount]},this))},error:function(){t(document).ready(n.bind(function(){this.fail(i.couldNotLoadData)},this))}})},this)).fail(n.bind(function(){t(document).ready(n.bind(function(){this.fail(i.couldNotLoadData)},this))},this)):void console.error(i.couldNotInitCanvas)},setupInitialData:function(t){var s,o,a,r,d,c;if(n.contains(l,this.instanceCount))if(t){if(this.form=new e.Builder.FormModel(t,{container_label_placeholder:i.defaultContainerLabel}),t._embedded.containers&&t._embedded.containers[0]&&(this.form.containers.add(t._embedded.containers[0]),t._embedded.elements&&t._embedded.elements[0])){for(d={},c=0;c<t._embedded.elements[0].length;c++)o=t._embedded.elements[0][c],s=this.form.containers.get(o.container_id),s&&(s.elements.add(o),d[o.id]=o.container_id);if(t._embedded.element_choices&&t._embedded.element_choices[0])for(c=0;c<t._embedded.element_choices[0].length;c++)a=t._embedded.element_choices[0][c],d[a.element_id]&&(s=this.form.containers.get(d[a.element_id]),s&&(o=s.elements.get(a.element_id),o&&o.element_choices.add(a)));if(t._embedded.element_settings&&t._embedded.element_settings[0])for(c=0;c<t._embedded.element_settings[0].length;c++)r=t._embedded.element_settings[0][c],d[r.element_id]&&(s=this.form.containers.get(d[r.element_id]),s&&(o=s.elements.get(r.element_id),o&&o.element_settings.add(r)))}}else this.form=new e.Builder.FormModel({},{container_label_placeholder:i.defaultContainerLabel}),this.form.containers.add({})},setupViews:function(){n.contains(l,this.instanceCount)&&(this.formView=new e.Builder.FormView(this.$el,this.form,{i18n:i}),this.formView.render())},onLoad:function(e){return n.isUndefined(r["builder"+this.instanceCount])?void e(this):void r["builder"+this.instanceCount].push(e)},fail:function(t){var n=e.template("failure");this.$el.find(".drag-drop-area").addClass("is-empty").html(n({message:t}))}}),e.Builder=s,e.Builder.getInstance=function(){return o||(o=new s("#torro-form-canvas"),o.init()),o},e.getFieldName=function(t,n){var i;if(t instanceof e.Builder.FormModel?i="forms":t instanceof e.Builder.ContainerModel?i="containers":t instanceof e.Builder.ElementModel?i="elements":t instanceof e.Builder.ElementChoiceModel?i="element_choices":t instanceof e.Builder.ElementSettingModel&&(i="element_settings"),i)return"torro_"+i+"["+t.get("id")+"]["+n+"]"}}(window.torro,window.jQuery,window._,window.torroBuilderI18n),function(e,t){"use strict";function n(e){this.attributes=e}t.extend(n.prototype,{getSlug:function(){return this.attributes.slug},getTitle:function(){return this.attributes.title},getDescription:function(){return this.attributes.description},getIconUrl:function(){return this.attributes.icon_url},isNonInput:function(){return this.attributes.non_input},isEvaluable:function(){return this.attributes.evaluable},isMultiField:function(){return this.attributes.multifield},getSections:function(){return this.attributes.sections},getFields:function(){return this.attributes.fields}}),e.ElementType=n}(window.torro.Builder,window._),function(e,t){"use strict";function n(e){var t;this.types={};for(t in e)this.types[e[t].getSlug()]=e[t]}t.extend(n.prototype,{get:function(e){if(!t.isUndefined(this.types[e]))return this.types[e]},getAll:function(){return this.types}}),n.fromApiCollection=function(i){var s=[];return i.each(function(n){var i=t.extend({},n.attributes);i._links&&delete i._links,i._embedded&&delete i._embedded,s.push(new e.ElementType(i))}),new n(s)},e.ElementTypes=n}(window.torro.Builder,window._),function(e,t,n,i){"use strict";e.BaseModel=i.Model.extend({links:{},constructor:function(e,s){var o=e||{},a=this.idAttribute||i.Model.prototype.idAttribute||"id";o._links&&(this.links=o._links),o=n.omit(o,["_links","_embedded"]),o[a]||(o[a]=t.generateTempId()),i.Model.apply(this,[o,s])},sync:function(e,t,i){return"create"===e&&t.has(t.idAttribute)&&(i.attrs||(i.attrs=t.toJSON(i)),i.attrs=n.omit(i.attrs,t.idAttribute)),!1},isNew:function(){return!this.has(this.idAttribute)||t.isTempId(this.get(this.idAttribute))}})}(window.torro.Builder,window.torro,window._,window.Backbone),function(e,t,n,i){"use strict";e.BaseCollection=i.Collection.extend({model:e.BaseModel,defaultProps:{},constructor:function(e,s){var o=n.defaults(s&&s.props||{},this.defaultProps);this.props=new i.Model(o),this.urlEndpoint&&(this.url=t.api.root+t.api.versionString+this.urlEndpoint),i.Collection.apply(this,arguments)},sync:function(){return!1}})}(window.torro.Builder,window.torro,window._,window.Backbone),function(e,t){"use strict";e.ContainerModel=e.BaseModel.extend({defaults:function(){return t.extend(t.clone({id:0,form_id:0,label:"",sort:0}),this.collection.getDefaultAttributes())},elements:void 0,constructor:function(n,i){n=n||{},t.isUndefined(n.addingElement)&&(i=i||{},i.addingElement?n.addingElement=!0:n.addingElement=!1),t.isUndefined(n.selectedElementType)&&(i=i||{},i.selectedElementType?n.selectedElementType=i.selectedElementType:n.selectedElementType=!1),e.BaseModel.apply(this,[n,i]),this.elements=new e.ElementCollection([],{props:{container_id:this.get("id")}})}})}(window.torro.Builder,window._),function(e,t){"use strict";e.ElementChoiceModel=e.BaseModel.extend({defaults:function(){return t.extend(t.clone({id:0,element_id:0,field:"",value:"",sort:0}),this.collection.getDefaultAttributes())}})}(window.torro.Builder,window._),function(e,t){"use strict";e.ElementModel=e.BaseModel.extend({defaults:function(){return t.extend(t.clone({id:0,container_id:0,label:"",sort:0,type:"textfield"}),this.collection.getDefaultAttributes())},element_choices:null,element_settings:void 0,constructor:function(t,n){e.BaseModel.apply(this,[t,n]),this.element_choices=new e.ElementChoiceCollection([],{props:{element_id:this.get("id")}}),this.element_settings=new e.ElementSettingCollection([],{props:{element_id:this.get("id")}})}})}(window.torro.Builder,window._),function(e,t){"use strict";e.ElementSettingModel=e.BaseModel.extend({defaults:function(){return t.extend(t.clone({id:0,element_id:0,name:"",value:""}),this.collection.getDefaultAttributes())}})}(window.torro.Builder,window._),function(e){"use strict";e.FormModel=e.BaseModel.extend({defaults:{id:0,title:"",slug:"",author:0,status:"draft",timestamp:0,timestamp_modified:0},containers:void 0,constructor:function(t,n){var i;e.BaseModel.apply(this,[t,n]),i={form_id:this.get("id")},"object"==typeof n&&n.container_label_placeholder&&(i.label_placeholder=n.container_label_placeholder),this.containers=new e.ContainerCollection([],{props:i})}})}(window.torro.Builder),function(e,t){"use strict";e.ContainerCollection=e.BaseCollection.extend({model:e.ContainerModel,urlEndpoint:"containers",defaultProps:{selected:!1,form_id:0,label_placeholder:"Page %s"},getDefaultAttributes:function(){var e,t=this.length+1,n=this.length;return this.length&&(e=this.at(this.length-1),e&&(n=e.get("sort")+1,e.get("label")===this.props.get("label_placeholder").replace("%s",n)&&(t=n+1))),{form_id:this.props.get("form_id"),label:this.props.get("label_placeholder").replace("%s",t),sort:n}},initialize:function(){this.on("add",t.bind(this.maybeUpdateSelectedOnAdd,this)),this.on("remove",t.bind(this.maybeUpdateSelectedOnRemove,this))},maybeUpdateSelectedOnAdd:function(e){e&&this.props.set("selected",e.get("id"))},maybeUpdateSelectedOnRemove:function(e,t,n){var i=n.index?n.index-1:n.index;e&&this.props.get("selected")===e.get("id")&&(this.length?this.props.set("selected",this.at(i).get("id")):this.props.set("selected",!1))}})}(window.torro.Builder,window._),function(e){"use strict";e.ElementChoiceCollection=e.BaseCollection.extend({model:e.ElementChoiceModel,urlEndpoint:"element_choices",defaultProps:{element_id:0},getDefaultAttributes:function(){return{element_id:this.props.get("element_id"),sort:this.length}}})}(window.torro.Builder),function(e){"use strict";e.ElementCollection=e.BaseCollection.extend({model:e.ElementModel,urlEndpoint:"elements",defaultProps:{active:[],container_id:0},getDefaultAttributes:function(){return{container_id:this.props.get("container_id"),sort:this.length}},toggleActive:function(e){var t=this.props.get("active"),n=t.indexOf(e);n>-1?t.splice(n,1):t.push(e),this.props.set("active",t),this.props.trigger("toggleActive",this,t,{})}})}(window.torro.Builder),function(e){"use strict";e.ElementSettingCollection=e.BaseCollection.extend({model:e.ElementSettingModel,urlEndpoint:"element_settings",defaultProps:{element_id:0},getDefaultAttributes:function(){return{element_id:this.props.get("element_id"),sort:this.length}}})}(window.torro.Builder),function(e){"use strict";e.FormCollection=e.BaseCollection.extend({model:e.FormModel,urlEndpoint:"forms"})}(window.torro.Builder),function(e,t,n){"use strict";function i(n,i){var s=n.get("id"),o=n.get("id")===n.collection.props.get("selected");this.container=n,this.options=i||{},this.tabTemplate=e.template("container-tab"),this.panelTemplate=e.template("container-panel"),this.footerPanelTemplate=e.template("container-footer-panel"),this.$tab=t("<button />"),this.$tab.attr("type","button"),this.$tab.attr("id","container-tab-"+s),this.$tab.addClass("torro-form-canvas-tab"),this.$tab.attr("aria-controls","container-panel-"+s+" container-footer-panel-"+s),this.$tab.attr("aria-selected",o?"true":"false"),this.$tab.attr("role","tab"),this.$panel=t("<div />"),this.$panel.attr("id","container-panel-"+s),this.$panel.addClass("torro-form-canvas-panel"),this.$panel.attr("aria-labelledby","container-tab-"+s),this.$panel.attr("aria-hidden",o?"false":"true"),this.$panel.attr("role","tabpanel"),this.$footerPanel=t("<div />"),this.$footerPanel.attr("id","container-footer-panel-"+s),this.$footerPanel.addClass("torro-form-canvas-panel"),this.$footerPanel.attr("aria-labelledby","container-tab-"+s),this.$footerPanel.attr("aria-hidden",o?"false":"true"),this.$footerPanel.attr("role","tabpanel")}n.extend(i.prototype,{render:function(){var t,i;for(t=n.clone(this.container.attributes),t.elementTypes=[],n.each(e.Builder.getInstance().elementTypes.getAll(),function(e){t.elementTypes.push(e.attributes)}),this.$tab.html(this.tabTemplate(this.container.attributes)),this.$panel.html(this.panelTemplate(t)),this.$footerPanel.html(this.footerPanelTemplate(this.container.attributes)),this.checkHasElements(),i=0;i<this.container.elements.length;i++)this.listenAddElement(this.container.elements.at(i));this.attach()},destroy:function(){this.detach(),this.$tab.remove(),this.$panel.remove(),this.$footerPanel.remove()},attach:function(){this.container.on("remove",this.listenRemove,this),this.container.elements.on("add",this.listenAddElement,this),this.container.elements.on("add remove reset",this.checkHasElements,this),this.container.on("change:label",this.listenChangeLabel,this),this.container.on("change:sort",this.listenChangeSort,this),this.container.on("change:addingElement",this.listenChangeAddingElement,this),this.container.on("change:selectedElementType",this.listenChangeSelectedElementType,this),this.container.collection.props.on("change:selected",this.listenChangeSelected,this),this.$tab.on("click",n.bind(this.setSelected,this)),this.$tab.on("dblclick",n.bind(this.editLabel,this)),this.$panel.on("click",".add-element-toggle",n.bind(this.toggleAddingElement,this)),this.$panel.on("click",".torro-element-type",n.bind(this.setSelectedElementType,this)),this.$panel.on("click",".add-element-button",n.bind(this.addElement,this)),this.$footerPanel.on("click",".delete-container-button",n.bind(this.deleteContainer,this))},detach:function(){this.container.collection.props.off("change:selected",this.listenChangeSelected,this),this.container.off("change:selectedElementType",this.listenChangeSelectedElementType,this),this.container.off("change:addingElement",this.listenChangeAddingElement,this),this.container.off("change:sort",this.listenChangeSort,this),this.container.off("change:label",this.listenChangeLabel,this),this.container.elements.off("add remove reset",this.checkHasElements,this),this.container.elements.off("add",this.listenAddContainer,this),this.container.off("remove",this.listenRemove,this),this.$footerPanel.off("click",".delete-container-button",n.bind(this.deleteContainer,this)),this.$panel.off("click",".add-element-button",n.bind(this.addElement,this)),this.$panel.off("click",".torro-element-type",n.bind(this.setSelectedElementType,this)),this.$panel.off("click",".add-element-toggle",n.bind(this.toggleAddingElement,this)),this.$tab.off("dblclick",n.bind(this.editLabel,this)),this.$tab.off("click",n.bind(this.setSelected,this))},listenRemove:function(){this.destroy()},listenAddElement:function(t){var n=new e.Builder.ElementView(t,this.options);this.$panel.find(".drag-drop-area").append(n.$wrap),n.render()},checkHasElements:function(){this.container.elements.length?this.$panel.find(".drag-drop-area").removeClass("is-empty"):this.$panel.find(".drag-drop-area").addClass("is-empty")},listenChangeLabel:function(t,n){var i=e.escapeSelector(e.getFieldName(this.container,"label"));this.$panel.find('input[name="'+i+'"]').val(n)},listenChangeSort:function(t,n){var i=e.escapeSelector(e.getFieldName(this.container,"sort"));this.$panel.find('input[name="'+i+'"]').val(n)},listenChangeAddingElement:function(e,t){t?(this.$panel.find(".add-element-toggle-wrap").addClass("is-expanded"),this.$panel.find(".add-element-toggle").attr("aria-expanded","true"),this.$panel.find(".add-element-content-wrap").addClass("is-expanded")):(this.$panel.find(".add-element-toggle-wrap").removeClass("is-expanded"),this.$panel.find(".add-element-toggle").attr("aria-expanded","false"),this.$panel.find(".add-element-content-wrap").removeClass("is-expanded"))},listenChangeSelectedElementType:function(t,n){var i;return this.$panel.find(".torro-element-type").removeClass("is-selected"),n&&(i=e.Builder.getInstance().elementTypes.get(n))?(this.$panel.find(".torro-element-type-"+i.getSlug()).addClass("is-selected"),void this.$panel.find(".add-element-button").prop("disabled",!1)):void this.$panel.find(".add-element-button").prop("disabled",!0)},listenChangeSelected:function(e,t){t===this.container.get("id")?(this.$tab.attr("aria-selected","true"),this.$panel.attr("aria-hidden","false"),this.$footerPanel.attr("aria-hidden","false")):(this.$tab.attr("aria-selected","false"),this.$panel.attr("aria-hidden","true"),this.$footerPanel.attr("aria-hidden","true"))},setSelected:function(){this.container.collection.props.set("selected",this.container.get("id"))},editLabel:function(){var e,n=this.container,i=this.$tab.find("span");i.length&&(e=t("<input />"),e.attr("type","text"),e.val(i.text()),e.on("keydown blur",function(t){var s,o=!1;"keydown"===t.type?13===t.which?(o=!0,t.preventDefault()):[32,37,38,39,40].includes(t.which)&&t.stopPropagation():"blur"===t.type?o=!0:t.stopPropagation(),o&&(s=e.val(),n.set("label",s),i.text(s),e.replaceWith(i),i.focus())}),i.replaceWith(e),e.focus())},toggleAddingElement:function(){this.container.get("addingElement")?this.container.set("addingElement",!1):this.container.set("addingElement",!0)},setSelectedElementType:function(e){var n=!1;e&&e.currentTarget&&(n=t(e.currentTarget).data("slug")),n?this.container.set("selectedElementType",n):this.container.set("selectedElementType",!1)},addElement:function(){var e,t=this.container.get("selectedElementType");t&&(e=this.container.elements.create({type:t}),this.toggleAddingElement(),this.setSelectedElementType(),this.container.elements.toggleActive(e.get("id")))},deleteContainer:function(){this.container.collection.remove(this.container)}}),e.Builder.ContainerView=i}(window.torro,window.jQuery,window._),function(e,t,n){"use strict";function i(n,i){var s=n.get("id");this.element=n,this.options=i||{},this.elementType=e.Builder.getInstance().elementTypes.get(this.element.get("type")),this.wrapTemplate=e.template("element"),this.$wrap=t("<div />"),this.$wrap.attr("id","torro-element-"+s),this.$wrap.addClass("torro-element")}n.extend(i.prototype,{render:function(){var e=this.element.attributes;e.type=this.elementType.attributes,e.active=this.element.collection.props.get("active").includes(this.element.get("id")),this.$wrap.html(this.wrapTemplate(e)).find("input,textarea,select").first().focus(),this.attach()},destroy:function(){this.detach(),this.$wrap.remove()},attach:function(){this.element.on("remove",this.listenRemove,this),this.element.on("change:label",this.listenChangeLabel,this),this.element.on("change:sort",this.listenChangeSort,this),this.element.collection.props.on("toggleActive",this.listenChangeActive,this),this.$wrap.on("click",".torro-element-expand-button",n.bind(this.toggleActive,this)),this.$wrap.on("click",".delete-element-button",n.bind(this.deleteElement,this))},detach:function(){this.element.collection.props.off("toggleActive",this.listenChangeActive,this),this.element.off("change:sort",this.listenChangeSort,this),this.element.off("change:label",this.listenChangeLabel,this),this.element.off("remove",this.listenRemove,this),this.$wrap.off("click",".delete-element-button",n.bind(this.deleteElement,this)),this.$wrap.off("click",".torro-element-expand-button",n.bind(this.toggleActive,this))},listenRemove:function(){this.destroy()},listenChangeLabel:function(t,n){var i=e.escapeSelector(e.getFieldName(this.element,"label"));this.$wrap.find('input[name="'+i+'"]').val(n)},listenChangeSort:function(t,n){var i=e.escapeSelector(e.getFieldName(this.element,"sort"));this.$wrap.find('input[name="'+i+'"]').val(n)},listenChangeActive:function(e,t){t.includes(this.element.get("id"))?(this.$wrap.find(".torro-element-expand-button").attr("aria-expanded","true").find(".screen-reader-text").text(this.options.i18n.hideContent),this.$wrap.find(".torro-element-content").addClass("is-expanded")):(this.$wrap.find(".torro-element-expand-button").attr("aria-expanded","false").find(".screen-reader-text").text(this.options.i18n.showContent),this.$wrap.find(".torro-element-content").removeClass("is-expanded"))},toggleActive:function(){this.element.collection.toggleActive(this.element.get("id"))},deleteElement:function(){this.element.collection.remove(this.element)}}),e.Builder.ElementView=i}(window.torro,window.jQuery,window._),function(e,t,n){"use strict";function i(t,n,i){this.form=n,this.options=i||{},this.canvasTemplate=e.template("form-canvas"),this.$canvas=t}n.extend(i.prototype,{render:function(){var e;for(console.log(this.form),this.$canvas.html(this.canvasTemplate(this.form.attributes)),this.$addButton=this.$canvas.find(".add-button"),this.$addPanel=this.$canvas.find(".add-panel"),this.checkHasContainers(),e=0;e<this.form.containers.length;e++)this.listenAddContainer(this.form.containers.at(e));this.attach()},destroy:function(){this.detach(),this.$canvas.empty()},attach:function(){this.form.containers.on("add",this.listenAddContainer,this),this.form.containers.on("add remove reset",this.checkHasContainers,this),this.$addButton.on("click",n.bind(this.addContainer,this))},detach:function(){this.form.containers.off("add remove reset",n.bind(this.checkHasContainers,this)),this.form.containers.off("add",this.listenAddContainer,this),this.$addButton.off("click",n.bind(this.addContainer,this))},listenAddContainer:function(t){var n=new e.Builder.ContainerView(t,this.options);n.$tab.insertBefore(this.$addButton),n.$panel.insertBefore(this.$addPanel),this.$canvas.find(".torro-form-canvas-footer").append(n.$footerPanel),n.render()},checkHasContainers:function(){this.form.containers.length?(this.$addButton.removeClass("is-active"),this.$addPanel.attr("aria-hidden","true")):(this.$addButton.addClass("is-active"),this.$addPanel.attr("aria-hidden","false"))},addContainer:function(){this.form.containers.create()}}),e.Builder.FormView=i}(window.torro,window.jQuery,window._),function(e){"use strict";e(".torro-metabox-tab").on("click",function(t){var n=e(this),i=n.parent().children(".torro-metabox-tab");t.preventDefault(),"true"!==n.attr("aria-selected")&&(i.each(function(){e(this).attr("aria-selected","false"),e(e(this).attr("href")).attr("aria-hidden","true")}),n.attr("aria-selected","true"),e(n.attr("href")).attr("aria-hidden","false").find(".plugin-lib-map-control").each(function(){e(this).wpMapPicker("refresh")}))})}(window.jQuery),function(e){"use strict";e.getInstance()}(window.torro.Builder);