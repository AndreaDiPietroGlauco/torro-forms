/*!
 * Torro Forms Version 1.0.0-beta.8 (http://torro-forms.com)
 * Licensed under GNU General Public License v3 (http://www.gnu.org/licenses/gpl-3.0.html)
 */
window.torro=window.torro||{},function(t,e,i,n){"use strict";function o(t){a++,l["builder"+a]=[],this.instanceNumber=a,this.$el=e(t)}var s,a=0,r=[],l={};i.extend(o.prototype,{elementTypes:void 0,form:void 0,formView:void 0,init:function(){return this.$el.length?void t.api.init().done(i.bind(function(){(new t.api.collections.ElementTypes).fetch({data:{context:"edit"},context:this,success:function(o){this.elementTypes=t.Builder.ElementTypes.fromApiCollection(o),"auto-draft"!==e("#original_post_status").val()?new t.api.models.Form({id:parseInt(e("#post_ID").val(),10)}).fetch({data:{context:"edit",_embed:!0},context:this,success:function(t){e(document).ready(i.bind(function(){var e;r.push(this.instanceCount),this.setupInitialData(t.attributes),this.setupViews();for(e in l["builder"+this.instanceCount])l["builder"+this.instanceCount][e](this);delete l["builder"+this.instanceCount]},this))},error:function(){e(document).ready(i.bind(function(){this.fail(n.couldNotLoadData)},this))}}):e(document).ready(i.bind(function(){var t;r.push(this.instanceCount),this.setupInitialData(),this.setupViews();for(t in l["builder"+this.instanceCount])l["builder"+this.instanceCount][t](this);delete l["builder"+this.instanceCount]},this))},error:function(){e(document).ready(i.bind(function(){this.fail(n.couldNotLoadData)},this))}})},this)).fail(i.bind(function(){e(document).ready(i.bind(function(){this.fail(n.couldNotLoadData)},this))},this)):void console.error(n.couldNotInitCanvas)},setupInitialData:function(e){var o,s,a,l,d,c;if(i.contains(r,this.instanceCount))if(e){if(this.form=new t.Builder.FormModel(e,{container_label_placeholder:n.defaultContainerLabel}),e._embedded.containers&&e._embedded.containers[0]&&(this.form.containers.add(e._embedded.containers[0]),e._embedded.elements&&e._embedded.elements[0])){for(d={},c=0;c<e._embedded.elements[0].length;c++)s=e._embedded.elements[0][c],o=this.form.containers.get(s.container_id),o&&(o.elements.add(s),d[s.id]=s.container_id);if(e._embedded.element_choices&&e._embedded.element_choices[0])for(c=0;c<e._embedded.element_choices[0].length;c++)a=e._embedded.element_choices[0][c],d[a.element_id]&&(o=this.form.containers.get(d[a.element_id]),o&&(s=o.elements.get(a.element_id),s&&s.element_choices.add(a)));if(e._embedded.element_settings&&e._embedded.element_settings[0])for(c=0;c<e._embedded.element_settings[0].length;c++)l=e._embedded.element_settings[0][c],d[l.element_id]&&(o=this.form.containers.get(d[l.element_id]),o&&(s=o.elements.get(l.element_id),s&&s.element_settings.add(l)))}}else this.form=new t.Builder.FormModel({},{container_label_placeholder:n.defaultContainerLabel}),this.form.containers.add({})},setupViews:function(){i.contains(r,this.instanceCount)&&(this.formView=new t.Builder.FormView(this.$el,this.form,{i18n:n}),this.formView.render())},onLoad:function(t){return i.isUndefined(l["builder"+this.instanceCount])?void t(this):void l["builder"+this.instanceCount].push(t)},fail:function(e){var i=t.template("failure");this.$el.find(".drag-drop-area").addClass("is-empty").html(i({message:e}))}}),t.Builder=o,t.Builder.getInstance=function(){return s||(s=new o("#torro-form-canvas"),s.init()),s},t.getFieldName=function(e,i){var n;if(e instanceof t.Builder.FormModel?n="forms":e instanceof t.Builder.ContainerModel?n="containers":e instanceof t.Builder.ElementModel?n="elements":e instanceof t.Builder.ElementChoiceModel?n="element_choices":e instanceof t.Builder.ElementSettingModel&&(n="element_settings"),n)return"torro_"+n+"["+e.get("id")+"]["+i+"]"}}(window.torro,window.jQuery,window._,window.torroBuilderI18n),function(t,e){"use strict";function i(t){this.attributes=t}e.extend(i.prototype,{getSlug:function(){return this.attributes.slug},getTitle:function(){return this.attributes.title},getDescription:function(){return this.attributes.description},getIconUrl:function(){return this.attributes.icon_url},isNonInput:function(){return this.attributes.non_input},isEvaluable:function(){return this.attributes.evaluable},isMultiField:function(){return this.attributes.multifield},getSections:function(){return this.attributes.sections},getFields:function(){return this.attributes.fields}}),t.ElementType=i}(window.torro.Builder,window._),function(t,e){"use strict";function i(t){var e;this.types={};for(e in t)this.types[t[e].getSlug()]=t[e]}e.extend(i.prototype,{get:function(t){if(!e.isUndefined(this.types[t]))return this.types[t]},getAll:function(){return this.types}}),i.fromApiCollection=function(n){var o=[];return n.each(function(i){var n=e.extend({},i.attributes);n._links&&delete n._links,n._embedded&&delete n._embedded,o.push(new t.ElementType(n))}),new i(o)},t.ElementTypes=i}(window.torro.Builder,window._),function(t,e,i,n){"use strict";t.BaseModel=n.Model.extend({links:{},constructor:function(t,o){var s=t||{},a=this.idAttribute||n.Model.prototype.idAttribute||"id";s._links&&(this.links=s._links),s=i.omit(s,["_links","_embedded"]),s[a]||(s[a]=e.generateTempId()),n.Model.apply(this,[s,o])},sync:function(t,e,n){return"create"===t&&e.has(e.idAttribute)&&(n.attrs||(n.attrs=e.toJSON(n)),n.attrs=i.omit(n.attrs,e.idAttribute)),!1},isNew:function(){return!this.has(this.idAttribute)||e.isTempId(this.get(this.idAttribute))}})}(window.torro.Builder,window.torro,window._,window.Backbone),function(t,e,i,n){"use strict";t.BaseCollection=n.Collection.extend({model:t.BaseModel,defaultProps:{},constructor:function(t,o){var s=i.defaults(o&&o.props||{},this.defaultProps);this.props=new n.Model(s),this.urlEndpoint&&(this.url=e.api.root+e.api.versionString+this.urlEndpoint),n.Collection.apply(this,arguments)},sync:function(){return!1}})}(window.torro.Builder,window.torro,window._,window.Backbone),function(t,e){"use strict";t.ContainerModel=t.BaseModel.extend({defaults:function(){return e.extend(e.clone({id:0,form_id:0,label:"",sort:0}),this.collection.getDefaultAttributes())},elements:void 0,constructor:function(e,i){t.BaseModel.apply(this,[e,i]),this.elements=new t.ElementCollection([],{props:{container_id:this.get("id")}})}})}(window.torro.Builder,window._),function(t,e){"use strict";t.ElementChoiceModel=t.BaseModel.extend({defaults:function(){return e.extend(e.clone({id:0,element_id:0,field:"",value:"",sort:0}),this.collection.getDefaultAttributes())}})}(window.torro.Builder,window._),function(t,e){"use strict";t.ElementModel=t.BaseModel.extend({defaults:function(){return e.extend(e.clone({id:0,container_id:0,label:"",sort:0,type:"textfield"}),this.collection.getDefaultAttributes())},element_choices:null,element_settings:void 0,constructor:function(e,i){t.BaseModel.apply(this,[e,i]),this.element_choices=new t.ElementChoiceCollection([],{props:{element_id:this.get("id")}}),this.element_settings=new t.ElementSettingCollection([],{props:{element_id:this.get("id")}})}})}(window.torro.Builder,window._),function(t,e){"use strict";t.ElementSettingModel=t.BaseModel.extend({defaults:function(){return e.extend(e.clone({id:0,element_id:0,name:"",value:""}),this.collection.getDefaultAttributes())}})}(window.torro.Builder,window._),function(t){"use strict";t.FormModel=t.BaseModel.extend({defaults:{id:0,title:"",slug:"",author:0,status:"draft",timestamp:0,timestamp_modified:0},containers:void 0,constructor:function(e,i){var n;t.BaseModel.apply(this,[e,i]),n={form_id:this.get("id")},"object"==typeof i&&i.container_label_placeholder&&(n.label_placeholder=i.container_label_placeholder),this.containers=new t.ContainerCollection([],{props:n})}})}(window.torro.Builder),function(t,e){"use strict";t.ContainerCollection=t.BaseCollection.extend({model:t.ContainerModel,urlEndpoint:"containers",defaultProps:{selected:!1,form_id:0,label_placeholder:"Page %s"},getDefaultAttributes:function(){var t,e=this.length+1,i=this.length;return this.length&&(t=this.at(this.length-1),t&&(i=t.get("sort")+1,t.get("label")===this.props.get("label_placeholder").replace("%s",i)&&(e=i+1))),{form_id:this.props.get("form_id"),label:this.props.get("label_placeholder").replace("%s",e),sort:i}},initialize:function(){this.on("add",e.bind(this.maybeUpdateSelectedOnAdd,this)),this.on("remove",e.bind(this.maybeUpdateSelectedOnRemove,this))},maybeUpdateSelectedOnAdd:function(t){t&&this.props.set("selected",t.get("id"))},maybeUpdateSelectedOnRemove:function(t,e,i){var n=i.index?i.index-1:i.index;t&&this.props.get("selected")===t.get("id")&&(this.length?this.props.set("selected",this.at(n).get("id")):this.props.set("selected",!1))}})}(window.torro.Builder,window._),function(t){"use strict";t.ElementChoiceCollection=t.BaseCollection.extend({model:t.ElementChoiceModel,urlEndpoint:"element_choices",defaultProps:{element_id:0},getDefaultAttributes:function(){return{element_id:this.props.get("element_id"),sort:this.length}}})}(window.torro.Builder),function(t){"use strict";t.ElementCollection=t.BaseCollection.extend({model:t.ElementModel,urlEndpoint:"elements",defaultProps:{active:[],container_id:0},getDefaultAttributes:function(){return{container_id:this.props.get("container_id"),sort:this.length}},toggleActive:function(t){var e=this.props.get("active"),i=e.indexOf(t);i>-1?e.splice(i,1):e.push(t),this.props.set("active",e)}})}(window.torro.Builder),function(t){"use strict";t.ElementSettingCollection=t.BaseCollection.extend({model:t.ElementSettingModel,urlEndpoint:"element_settings",defaultProps:{element_id:0},getDefaultAttributes:function(){return{element_id:this.props.get("element_id"),sort:this.length}}})}(window.torro.Builder),function(t){"use strict";t.FormCollection=t.BaseCollection.extend({model:t.FormModel,urlEndpoint:"forms"})}(window.torro.Builder),function(t,e,i){"use strict";function n(i,n){var o=i.get("id"),s=i.get("id")===i.collection.props.get("selected");this.container=i,this.options=n||{},this.tabTemplate=t.template("container-tab"),this.panelTemplate=t.template("container-panel"),this.footerPanelTemplate=t.template("container-footer-panel"),this.$tab=e("<button />"),this.$tab.attr("type","button"),this.$tab.attr("id","container-tab-"+o),this.$tab.addClass("torro-form-canvas-tab"),this.$tab.attr("aria-controls","container-panel-"+o+" container-footer-panel-"+o),this.$tab.attr("aria-selected",s?"true":"false"),this.$tab.attr("role","tab"),this.$panel=e("<div />"),this.$panel.attr("id","container-panel-"+o),this.$panel.addClass("torro-form-canvas-panel"),this.$panel.attr("aria-labelledby","container-tab-"+o),this.$panel.attr("aria-hidden",s?"false":"true"),this.$panel.attr("role","tabpanel"),this.$footerPanel=e("<div />"),this.$footerPanel.attr("id","container-footer-panel-"+o),this.$footerPanel.addClass("torro-form-canvas-panel"),this.$footerPanel.attr("aria-labelledby","container-tab-"+o),this.$footerPanel.attr("aria-hidden",s?"false":"true"),this.$footerPanel.attr("role","tabpanel")}i.extend(n.prototype,{render:function(){var t;for(this.$tab.html(this.tabTemplate(this.container.attributes)),this.$panel.html(this.panelTemplate(this.container.attributes)),this.$footerPanel.html(this.footerPanelTemplate(this.container.attributes)),this.checkHasElements(),t=0;t<this.container.elements.length;t++)this.listenAddElement(this.container.elements.at(t));this.attach()},destroy:function(){this.detach(),this.$tab.remove(),this.$panel.remove(),this.$footerPanel.remove()},attach:function(){this.container.on("remove",this.listenRemove,this),this.container.elements.on("add",this.listenAddContainer,this),this.container.elements.on("add remove reset",this.checkHasElements,this),this.container.on("change:label",this.listenChangeLabel,this),this.container.on("change:sort",this.listenChangeSort,this),this.container.collection.props.on("change:selected",this.listenChangeSelected,this),this.$tab.on("click",i.bind(this.setSelected,this)),this.$tab.on("dblclick",i.bind(this.editLabel,this)),this.$footerPanel.on("click",".delete-container-button",i.bind(this.deleteContainer,this))},detach:function(){this.container.collection.props.off("change:selected",this.listenChangeSelected,this),this.container.off("change:sort",this.listenChangeSort,this),this.container.off("change:label",this.listenChangeLabel,this),this.container.elements.off("add remove reset",this.checkHasElements,this),this.container.elements.off("add",this.listenAddContainer,this),this.container.off("remove",this.listenRemove,this),this.$footerPanel.off("click",".delete-container-button",i.bind(this.deleteContainer,this)),this.$tab.off("dblclick",i.bind(this.editLabel,this)),this.$tab.off("click",i.bind(this.setSelected,this))},listenRemove:function(){this.destroy()},listenAddElement:function(e){var i=new t.Builder.ElementView(e,this.options);this.$panel.find(".drag-drop-area").append(i.$wrap),i.render()},checkHasElements:function(){this.container.elements.length?this.$panel.find(".drag-drop-area").removeClass("is-empty"):this.$panel.find(".drag-drop-area").addClass("is-empty")},listenChangeLabel:function(e,i){var n=t.escapeSelector(t.getFieldName(this.container,"label"));this.$panel.find('input[name="'+n+'"]').val(i)},listenChangeSort:function(e,i){var n=t.escapeSelector(t.getFieldName(this.container,"sort"));this.$panel.find('input[name="'+n+'"]').val(i)},listenChangeSelected:function(t,e){e===this.container.get("id")?(this.$tab.attr("aria-selected","true"),this.$panel.attr("aria-hidden","false"),this.$footerPanel.attr("aria-hidden","false")):(this.$tab.attr("aria-selected","false"),this.$panel.attr("aria-hidden","true"),this.$footerPanel.attr("aria-hidden","true"))},setSelected:function(){this.container.collection.props.set("selected",this.container.get("id"))},editLabel:function(){var t,i=this.container,n=this.$tab.find("span");n.length&&(t=e("<input />"),t.attr("type","text"),t.val(n.text()),t.on("keydown blur",function(e){var o,s=!1;"keydown"===e.type?13===e.which?(s=!0,e.preventDefault()):[32,37,38,39,40].includes(e.which)&&e.stopPropagation():"blur"===e.type?s=!0:e.stopPropagation(),s&&(o=t.val(),i.set("label",o),n.text(o),t.replaceWith(n),n.focus())}),n.replaceWith(t),t.focus())},deleteContainer:function(){this.container.collection.remove(this.container)}}),t.Builder.ContainerView=n}(window.torro,window.jQuery,window._),function(t,e,i){"use strict";function n(i,n){var o=i.get("id");this.element=i,this.options=n||{},this.elementType=t.Builder.getInstance().elementTypes.get(this.element.get("type")),this.wrapTemplate=t.template("element"),this.$wrap=e("<div />"),this.$wrap.attr("id","torro-element-"+o),this.$wrap.addClass("torro-element")}i.extend(n.prototype,{render:function(){var t=this.element.attributes;t.type=this.elementType.attributes,t.active=this.element.collection.props.get("active").includes(this.element.get("id")),this.$wrap.html(this.wrapTemplate(t)),this.attach()},destroy:function(){this.detach(),this.$wrap.remove()},attach:function(){this.element.on("remove",this.listenRemove,this),this.element.on("change:label",this.listenChangeLabel,this),this.element.on("change:sort",this.listenChangeSort,this),this.element.collection.props.on("change:active",this.listenChangeActive,this),this.$wrap.on("click",".torro-element-expand-button",i.bind(this.toggleActive,this)),this.$wrap.on("click",".delete-element-button",i.bind(this.deleteElement,this))},detach:function(){this.element.collection.props.off("change:active",this.listenChangeActive,this),this.element.off("change:sort",this.listenChangeSort,this),this.element.off("change:label",this.listenChangeLabel,this),this.element.off("remove",this.listenRemove,this),this.$wrap.off("click",".delete-element-button",i.bind(this.deleteElement,this)),this.$wrap.off("click",".torro-element-expand-button",i.bind(this.toggleActive,this))},listenRemove:function(){this.destroy()},listenChangeLabel:function(e,i){var n=t.escapeSelector(t.getFieldName(this.element,"label"));this.$wrap.find('input[name="'+n+'"]').val(i)},listenChangeSort:function(e,i){var n=t.escapeSelector(t.getFieldName(this.element,"sort"));this.$wrap.find('input[name="'+n+'"]').val(i)},listenChangeActive:function(t,e){e.includes(this.element.get("id"))?(this.$wrap.find(".torro-element-expand-button").attr("aria-expanded","true").find(".screen-reader-text").text(this.options.i18n.hideContent),this.$wrap.find(".torro-element-content").addClass("is-expanded")):(this.$wrap.find(".torro-element-expand-button").attr("aria-expanded","false").find(".screen-reader-text").text(this.options.i18n.showContent),this.$wrap.find(".torro-element-content").removeClass("is-expanded"))},toggleActive:function(){this.element.collection.toggleActive(this.element.get("id"))},deleteElement:function(){this.element.collection.remove(this.element)}}),t.Builder.ElementView=n}(window.torro,window.jQuery,window._),function(t,e,i){"use strict";function n(e,i,n){this.form=i,this.options=n||{},this.canvasTemplate=t.template("form-canvas"),this.$canvas=e}i.extend(n.prototype,{render:function(){var t;for(console.log(this.form),this.$canvas.html(this.canvasTemplate(this.form.attributes)),this.$addButton=this.$canvas.find(".add-button"),this.$addPanel=this.$canvas.find(".add-panel"),this.checkHasContainers(),t=0;t<this.form.containers.length;t++)this.listenAddContainer(this.form.containers.at(t));this.attach()},destroy:function(){this.detach(),this.$canvas.empty()},attach:function(){this.form.containers.on("add",this.listenAddContainer,this),this.form.containers.on("add remove reset",this.checkHasContainers,this),this.$addButton.on("click",i.bind(this.addContainer,this))},detach:function(){this.form.containers.off("add remove reset",i.bind(this.checkHasContainers,this)),this.form.containers.off("add",this.listenAddContainer,this),this.$addButton.off("click",i.bind(this.addContainer,this))},listenAddContainer:function(e){var i=new t.Builder.ContainerView(e,this.options);i.$tab.insertBefore(this.$addButton),i.$panel.insertBefore(this.$addPanel),this.$canvas.find(".torro-form-canvas-footer").append(i.$footerPanel),i.render()},checkHasContainers:function(){this.form.containers.length?(this.$addButton.removeClass("is-active"),this.$addPanel.attr("aria-hidden","true")):(this.$addButton.addClass("is-active"),this.$addPanel.attr("aria-hidden","false"))},addContainer:function(){this.form.containers.create()}}),t.Builder.FormView=n}(window.torro,window.jQuery,window._),function(t){"use strict";t(".torro-metabox-tab").on("click",function(e){var i=t(this),n=i.parent().children(".torro-metabox-tab");e.preventDefault(),"true"!==i.attr("aria-selected")&&(n.each(function(){t(this).attr("aria-selected","false"),t(t(this).attr("href")).attr("aria-hidden","true")}),i.attr("aria-selected","true"),t(i.attr("href")).attr("aria-hidden","false").find(".plugin-lib-map-control").each(function(){t(this).wpMapPicker("refresh")}))})}(window.jQuery),function(t){"use strict";t.getInstance()}(window.torro.Builder);